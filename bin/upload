#!/usr/bin/env bash

# Edit these values:
AWS_PROFILE=jc21
S3_BUCKET=jc21-dashboard


# Do not edit below this line

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Code path
if hash realpath 2>/dev/null; then
    export CODEBASE=$(realpath $SCRIPT_DIR/..)
elif hash grealpath 2>/dev/null; then
    export CODEBASE=$(grealpath $SCRIPT_DIR/..)
else
    export CODEBASE=$(readlink -e $SCRIPT_DIR/..)
fi

if [ -z "$CODEBASE" ]; then
    echo "Unable to determine absolute codebase directory"
    exit 1
fi

cd "$CODEBASE/web"

s3cmd -v -f -P -m text/html sync "index.html" "s3://$S3_BUCKET/"
s3cmd -v -f -P -m application/json sync "version.json" "s3://$S3_BUCKET/"

cd dist

for DIR in *
do
    PARAM_STRING="--guess-mime-type"
    if [ "$DIR" == "css" ]; then
        PARAM_STRING="-m text/css"
    elif [ "$DIR" == "js" ]; then
        PARAM_STRING="-m application/javascript"
    elif [[ "$DIR" == *html ]]; then
        PARAM_STRING="-m text/html"
    elif [[ "$DIR" == *json ]]; then
        PARAM_STRING="-m application/json"
    fi

    #echo "========================================================="
    #echo s3cmd -v -f -P $PARAM_STRING sync "$DIR" "s3://$S3_BUCKET/dist/"

    s3cmd -v -f -P $PARAM_STRING sync "$DIR" "s3://$S3_BUCKET/dist/"

    # exit if bad return code
    rc=$?; if [ $rc != 0 ]; then exit $rc; fi
done

echo "Done!"
